matrix:
  include:
  - env: CONTAINERD_BRANCH=master
  - env: CONTAINERD_BRANCH=release/1.3
    go: 
    - 1.12.15
dist: bionic
sudo: required
language: go
os:
- linux
go:
- "1.13.6"
branches:
  only:
  - master
addons:
  apt:
    packages:
    - btrfs-tools
    - libseccomp-dev
before_install:
- uname -r
install:
- mkdir -p "${GOPATH}/src/github.com/containerd/containerd"
- git clone --branch "${CONTAINERD_BRANCH}" https://github.com/containerd/containerd.git "${GOPATH}/src/github.com/containerd/containerd"
- export RUNC_COMMIT=$(grep opencontainers/runc ${GOPATH}/src/github.com/containerd/containerd/vendor.conf | cut -d " " -f 2)
- export RUNC_COMMIT="dc9208a3303feef5b3839f4323d9beb36df0a9dd" # v1.0.0-rc10, TODO: remove this hack
- go get -d github.com/opencontainers/runc
- cd $GOPATH/src/github.com/opencontainers/runc
- git checkout $RUNC_COMMIT
- cd $GOPATH/src/github.com/containerd/containerd
script:
- export gitVersion="$(cd "${GOPATH}/src/github.com/containerd/containerd" && git describe --match 'v[0-9]*' --dirty='.m' --always)+kind-ci"
- export TRAVIS_TAG="containerd-${gitVersion#v}"
- echo "${TRAVIS_TAG}"
- cd $TRAVIS_BUILD_DIR
- if curl -sSLf "https://api.github.com/repos/kind-ci/containerd-nightlies/releases/tags/${TRAVIS_TAG}" -o /dev/null; then echo "Release exists, skip the build" ; unset TRAVIS_TAG ; exit 0 ; fi
- sudo PATH=$PATH GOPATH=$GOPATH $TRAVIS_BUILD_DIR/release-containerd-nightly.sh
before_deploy:
- git config --local user.name "kind-ci-robot"
- git config --local user.email "46937763+kind-ci-robot@users.noreply.github.com"
- cd $TRAVIS_BUILD_DIR
- if git rev-parse "${TRAVIS_TAG}"; then echo "Deleting old tag" && git tag -d "${TRAVIS_TAG}"; fi
- git tag "${TRAVIS_TAG}"
deploy:
  provider: releases
  api_key:
    secure: "A3QBy+xq+YuptsMKUTQReuJ030l1hX4TiC07kDlbo//McmuZfx9WNY1PLu0Tz4Ije1cbjIOdVOgViv99lFrEq6DrWR0ebZmS5uy8VMdncfR9WwRHQ1T47goUpMred9/EZuzhJh6LXvccnXt2PEqqenVHw2UtScedXyoo1ioaJgU76Bv5gsXMg3hTmqjcEnouHNY8i3JEg4NbAMF+sNQxLTXB2ke8Kix1Y+52OHfK5uH89zl5AGxvuh4TSU+DGcjaq604PvIaswuk2KORm3tKyfo9qCj5yCmsNmDaBmiuSX55ptxmAOPdumu4/m0AVxD/19GddcZfWHjQ3UIpDaQIf2xReYM3YFC1+aol8yzYCp/osmf2jPbiNbk51uT68w7sqJ+mGd9UsQllvVIdg9uYj5MmAS3QfacJ6Jn8xiJhdLyyNv5iMm2lm2wG5R7lW0SmNBmUab5H8ww+0MUguLvAC/wyBErA07vfyOIF4Rzts464qIkhwNcjIJwtz0H3Mu4ytQLI5glb9H5p+BOZX7l0X6Zs9CaAbAJHJTP8gWs7N7oVy1rd/qFDbcDkjMXkJfwIgo+VL0wrWRUykOsaZ1iphGs2yDDavmrFSAcZXEsiIAraB/4+N3eULtiiDn9D728RxIwWu8nUTkDZapcyp0hDmY60VU8Ql5XurZA1g9P+lKo="
  file_glob: true
  file:
  - $GOPATH/src/github.com/containerd/containerd/releases/*.tar.gz
  - $GOPATH/src/github.com/containerd/containerd/releases/*.tar.gz.sha256sum
  - $GOPATH/src/github.com/containerd/containerd/releases/runc.*
  name: ${TRAVIS_TAG} Build $(date +'%d.%m.%Y %R')
  skip_cleanup: true
  on:
    repo: kind-ci/containerd-nightlies
    tags: true
